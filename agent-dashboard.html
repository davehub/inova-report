<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InovaReport - Dashboard Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        /* Nouveaux styles pour la validation */
        .status-validated {
            background-color: #10B981 !important;
            color: white !important;
        }
        .status-pending {
            background-color: #F59E0B !important;
            color: white !important;
        }
        .validation-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }
        .disabled-field {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }
        .info-bubble {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg sticky top-0 z-40 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-indigo-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">InovaReport - Agent</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Bonjour, <span id="agentName" class="font-semibold"></span></span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 transition">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Cartes de Statistiques -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Rapports</p>
                        <p class="text-2xl font-bold text-gray-800" id="agentTotalReports">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-calendar-week text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Cette Semaine</p>
                        <p class="text-2xl font-bold text-gray-800" id="agentWeekReports">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-clock text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm font-medium">En Cours</p>
                        <p class="text-2xl font-bold text-gray-800" id="agentPendingReports">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bouton Nouveau Rapport -->
        <div class="flex justify-between items-center mb-6 no-print">
            <button onclick="openReportModal()" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-800 transition-all duration-300 shadow-lg">
                <i class="fas fa-plus mr-2"></i> Nouveau Rapport d'Intervention
            </button>
        </div>

        <!-- Tableau des Rapports -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-indigo-600 to-blue-700">
                <h2 class="text-xl font-bold text-white">Mes Rapports d'Intervention</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Durée</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="agentReportsTableBody" class="divide-y divide-gray-200">
                        <!-- État de chargement -->
                        <tr id="loadingRow">
                            <td colspan="6" class="px-6 py-8 text-center">
                                <div class="flex justify-center items-center space-x-3">
                                    <div class="loading-spinner"></div>
                                    <span class="text-gray-500">Chargement des rapports...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div id="noAgentReports" class="hidden text-center py-12">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-folder-open text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-600 mb-2">Aucun rapport trouvé</h3>
                    <p class="text-gray-500">Commencez par créer votre premier rapport d'intervention</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Backdrop pour le modal -->
    <div id="modalBackdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Modal de création de rapport MODIFIÉ -->
    <div id="reportModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <!-- En-tête du modal -->
                <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-blue-700 p-6 rounded-t-xl flex justify-between items-center z-10">
                    <h3 id="modalTitle" class="text-2xl font-bold text-white">Créer un Nouveau Rapport d'Intervention</h3>
                    <button onclick="closeReportModal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition" title="Fermer">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
    
                <form id="newReportForm" class="flex-grow overflow-y-auto p-8 space-y-6">
    
                    <!-- Section Information Client -->
                    <div class="border-b pb-4 border-gray-100">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user-tag text-blue-500 mr-3"></i>Information Client
                        </h4>
                        
                        <!-- Message d'information pour l'agent -->
                        <div class="info-bubble">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
                                <div>
                                    <p class="text-sm text-blue-700 font-medium">
                                        Sélectionnez un client existant dans la liste
                                    </p>
                                    <p class="text-xs text-blue-600 mt-1">
                                        Si le client n'existe pas, contactez votre responsable IT pour l'ajouter au système.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label for="reportClientSelect" class="block text-sm font-medium text-gray-700 mb-1">
                                    Raison Sociale (Client) *
                                </label>
                                <select id="reportClientSelect" required title="Sélectionnez un client existant"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="">Sélectionnez un client</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Client manquant ? Contactez votre responsable IT
                                </p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="reportInterlocutor" class="block text-sm font-medium text-gray-700 mb-1">
                                    Interlocuteur *
                                </label>
                                <input type="text" id="reportInterlocutor" required placeholder="Nom de la personne contactée"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>
                            <div>
                                <label for="reportContact" class="block text-sm font-medium text-gray-700 mb-1">
                                    Contact (Email ou Tél.) *
                                </label>
                                <input type="text" id="reportContact" required placeholder="Email ou Téléphone"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Détails de la Mission -->
                    <div class="border-b pb-4 border-gray-100 pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-tools text-blue-500 mr-3"></i>Détails de la Mission
                        </h4>
                        
                        <!-- Message d'information pour l'agent -->
                        <div class="info-bubble">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
                                <div>
                                    <p class="text-sm text-blue-700 font-medium">
                                        Sélectionnez un logiciel existant dans la liste
                                    </p>
                                    <p class="text-xs text-blue-600 mt-1">
                                        Si le logiciel n'existe pas, contactez votre responsable IT pour l'ajouter au système.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="reportDate" class="block text-sm font-medium text-gray-700 mb-1">
                                    Date d'Intervention *
                                </label>
                                <input type="date" id="reportDate" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>
                            <div>
                                <label for="reportSite" class="block text-sm font-medium text-gray-700 mb-1">
                                    Site Géographique *
                                </label>
                                <input type="text" id="reportSite" required placeholder="Ville ou Adresse du Site"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-6 mt-4">
                            <div>
                                <label for="reportSoftwareSelect" class="block text-sm font-medium text-gray-700 mb-1">
                                    Logiciel *
                                </label>
                                <select id="reportSoftwareSelect" required title="Sélectionnez un logiciel existant"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="">Sélectionnez le logiciel</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Logiciel manquant ? Contactez votre responsable IT
                                </p>
                            </div>
                        </div>
                    </div>
    
                    <!-- Section Modalités et Temps -->
                    <div class="border-b pb-4 border-gray-100 pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clock text-blue-500 mr-3"></i>Modalités et Temps
                        </h4>
                        
                        <!-- Configuration de base -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div>
                                <label for="reportInterventionType" class="block text-sm font-medium text-gray-700 mb-1">
                                    Type d'Intervention *
                                </label>
                                <select id="reportInterventionType" required title="Sélectionnez le mode d'intervention"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="">Mode d'Intervention</option>
                                    <option value="En Ligne">En Ligne</option>
                                    <option value="Sur Site">Sur Site</option>
                                </select>
                            </div>
                            <div>
                                <label for="reportContract" class="block text-sm font-medium text-gray-700 mb-1">
                                    Sous Contrat *
                                </label>
                                <select id="reportContract" required title="Sous Contrat (Oui/Non)"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="">Choisir</option>
                                    <option value="OUI">OUI</option>
                                    <option value="NON">NON</option>
                                </select>
                            </div>
                            <div>
                                <label for="reportDurationUnit" class="block text-sm font-medium text-gray-700 mb-1">
                                    Unité de Mesure *
                                </label>
                                <select id="reportDurationUnit" required title="Unité de durée" onchange="toggleDurationFields()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="">Choisir l'unité</option>
                                    <option value="Heure">Heure(s)</option>
                                    <option value="Jour">Jour(s)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Champs de durée -->
                        <div id="durationFieldsContainer" class="mt-6">
                            <!-- Champs pour les heures -->
                            <div id="hourDurationFields" class="hidden">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <label for="reportHourCount" class="block text-sm font-medium text-blue-700 mb-2">
                                        <i class="fas fa-clock mr-2"></i>Nombre d'heures *
                                    </label>
                                    <div class="flex items-center space-x-4">
                                        <input type="number" id="reportHourCount" min="0.5" max="24" step="0.5" 
                                                placeholder="Ex: 2.5 pour 2h30"
                                                class="w-32 px-4 py-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white">
                                        <span class="text-sm text-blue-600 font-medium">heure(s)</span>
                                    </div>
                                    <p class="text-xs text-blue-500 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Utilisez 0.5 pour une demi-heure (30 minutes)
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Champs pour les jours -->
                            <div id="dayDurationFields" class="hidden">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <label for="reportDayCount" class="block text-sm font-medium text-green-700 mb-2">
                                        <i class="fas fa-calendar-day mr-2"></i>Nombre de jours *
                                    </label>
                                    <div class="flex items-center space-x-4">
                                        <input type="number" id="reportDayCount" min="0.5" max="30" step="0.5" 
                                                placeholder="Ex: 1.5 pour 1 jour et demi"
                                                class="w-32 px-4 py-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white">
                                        <span class="text-sm text-green-600 font-medium">jour(s)</span>
                                    </div>
                                    <p class="text-xs text-green-500 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Utilisez 0.5 pour une demi-journée
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Message d'information -->
                            <div id="durationHelp" class="mt-4 text-center">
                                <p class="text-sm text-gray-500 italic">
                                    Sélectionnez une unité de mesure pour configurer la durée
                                </p>
                            </div>
                        </div>
                    </div>
    
                    <!-- Section Statut du Rapport -->
                    <div class="border-b pb-4 border-gray-100 pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-flag text-blue-500 mr-3"></i>Statut du Rapport
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="reportStatus" class="block text-sm font-medium text-gray-700 mb-1">
                                    Statut *
                                </label>
                                <select id="reportStatus" required title="Sélectionnez le statut du rapport"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                                    <option value="En Cours" selected>En Cours</option>
                                    <option value="Terminé">Terminé</option>
                                    <option value="Annulé">Annulé</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Le statut "Terminé" sera définitif après validation par le responsable
                                </p>
                            </div>
                        </div>
                    </div>
    
                    <!-- Section Objet de la Mission -->
                    <div class="pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-file-alt text-blue-500 mr-3"></i>Objet de la Mission
                        </h4>
                        <div>
                            <label for="reportObject" class="block text-sm font-medium text-gray-700 mb-1">
                                Objet de Mission *
                            </label>
                            <textarea id="reportObject" required rows="4" placeholder="Description détaillée de l'objet de la mission, des problèmes rencontrés et des solutions apportées..."
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-vertical"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-lightbulb mr-1"></i>
                                Décrivez précisément l'intervention réalisée
                            </p>
                        </div>
                    </div>
    
                    <!-- Message de statut -->
                    <div id="reportMessage" class="hidden px-4 py-3 rounded-lg text-sm font-medium"></div>
    
                </form>
    
                <!-- Pied de page du modal -->
                <div class="p-6 pt-4 flex justify-end space-x-4 sticky bottom-0 bg-white rounded-b-xl border-t border-gray-100 z-10">
                    <button type="button" onclick="closeReportModal()" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-semibold">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </button>
                    <button type="button" onclick="submitReport()" id="saveReportBtn"
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-lg hover:from-blue-700 hover:to-indigo-800 transition duration-150 font-semibold shadow-md flex items-center">
                        <i class="fas fa-save mr-2"></i>Enregistrer le Rapport
                    </button>
                </div>
    
            </div>
        </div>
    </div>

    <!-- Modal de détails du rapport -->
    <div id="detailsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-700 p-6 rounded-t-xl flex justify-between items-center no-print">
                    <h3 class="text-2xl font-bold text-white">Détails du Rapport</h3>
                    <div class="flex space-x-2">
                        <button onclick="printCurrentReport()" class="text-white hover:bg-white/20 p-2 rounded-lg transition" title="Imprimer">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="sendReportByEmail()" class="text-white hover:bg-white/20 p-2 rounded-lg transition" title="Envoyer par email">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <!-- Bouton modification conditionnel -->
                        <button id="editReportButton" onclick="editCurrentReport()" class="text-white hover:bg-white/20 p-2 rounded-lg transition" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="closeDetailsModal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition" title="Fermer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="reportDetails" class="p-6">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Section d'impression -->
    <div id="printSection" class="print-only hidden">
        <div class="p-8">
            <div class="text-center mb-8 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">InovaReport</h1>
                <h2 class="text-xl text-gray-600 mt-2">Rapport d'Intervention Technique</h2>
                <p class="text-gray-500 mt-2">Généré le <span id="printDate"></span></p>
            </div>
            <div id="printContent">
                <!-- Contenu d'impression chargé dynamiquement -->
            </div>
        </div>
    </div>
   
    <script type="module">
        import authService from './js/services/auth.js';
        import { db } from './js/config/firebase.js';
        import { 
            collection, 
            getDocs, 
            doc, 
            getDoc,
            addDoc,
            updateDoc,
            query,
            where,
            orderBy,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
        // Variables globales
        let currentAgent = null;
        let agentReports = [];
        let currentReportDetails = null;
        let currentEditingReportId = null;
        let clientsList = [];
        let softwareList = [];
    
        // =================================================================
        // INITIALISATION ET AUTHENTIFICATION
        // =================================================================
    
        // Vérifier l'authentification et le rôle
        authService.onAuthStateChange(async (result) => {
            if (!result.success || !result.user) {
                window.location.href = 'login.html';
                return;
            }
    
            const user = result.user;
            if (user.role !== 'agent') {
                if (user.role === 'responsable' || user.role === 'admin') {
                    window.location.href = 'responsable-dashboard.html';
                } else {
                    authService.logout();
                }
                return;
            }
    
            // Initialiser le dashboard
            document.getElementById('agentName').textContent = user.fullName || 'Agent';
            currentAgent = { uid: user.uid, name: user.fullName || 'Agent', role: user.role };
            await initializeDashboard(user.uid);
        });
    
        // Initialisation du dashboard
        async function initializeDashboard(agentUid) {
            showLoadingState();
            await loadClients();
            await loadSoftware();
            await loadAgentReports(agentUid);
            hideLoadingState();
        }
    
        // =================================================================
        // GESTION DU CHARGEMENT
        // =================================================================
    
        // Afficher l'état de chargement
        function showLoadingState() {
            document.getElementById('loadingRow').classList.remove('hidden');
            document.getElementById('noAgentReports').classList.add('hidden');
        }
    
        // Cacher l'état de chargement
        function hideLoadingState() {
            document.getElementById('loadingRow').classList.add('hidden');
        }
    
        // =================================================================
        // CHARGEMENT DES DONNÉES
        // =================================================================
    
        // Charger la liste des clients
        async function loadClients() {
            try {
                const querySnapshot = await getDocs(collection(db, 'clients'));
                clientsList = [];
                const clientSelect = document.getElementById('reportClientSelect');
                clientSelect.innerHTML = '<option value="">Sélectionnez un client</option>';
                
                querySnapshot.forEach((doc) => {
                    const client = { id: doc.id, ...doc.data() };
                    clientsList.push(client);
                    const option = document.createElement('option');
                    option.value = client.name;
                    option.textContent = client.name;
                    clientSelect.appendChild(option);
                });

                // Si aucun client n'existe, afficher un message
                if (clientsList.length === 0) {
                    clientSelect.innerHTML = '<option value="">Aucun client disponible - Contactez le responsable IT</option>';
                }
            } catch (error) {
                console.error('Erreur de chargement des clients:', error);
                const clientSelect = document.getElementById('reportClientSelect');
                clientSelect.innerHTML = '<option value="">Erreur de chargement - Contactez le responsable IT</option>';
            }
        }
    
        // Charger la liste des logiciels
        async function loadSoftware() {
            try {
                console.log('Chargement des logiciels...');
                
                const softwareSelect = document.getElementById('reportSoftwareSelect');
                softwareSelect.innerHTML = '<option value="">Chargement des logiciels...</option>';
                
                const querySnapshot = await getDocs(collection(db, 'software'));
                softwareList = [];
                softwareSelect.innerHTML = '<option value="">Sélectionnez le logiciel</option>';
                
                querySnapshot.forEach((doc) => {
                    const software = { id: doc.id, ...doc.data() };
                    softwareList.push(software);
                    
                    const option = document.createElement('option');
                    option.value = software.name;
                    option.textContent = software.name;
                    softwareSelect.appendChild(option);
                });

                // Si aucun logiciel n'existe, afficher un message
                if (softwareList.length === 0) {
                    softwareSelect.innerHTML = '<option value="">Aucun logiciel disponible - Contactez le responsable IT</option>';
                }
                
            } catch (error) {
                console.error('Erreur de chargement des logiciels:', error);
                const softwareSelect = document.getElementById('reportSoftwareSelect');
                softwareSelect.innerHTML = '<option value="">Erreur de chargement - Contactez le responsable IT</option>';
            }
        }
    
        // Charger les rapports de l'agent
        async function loadAgentReports(agentUid) {
            try {
                console.log('Chargement des rapports pour:', agentUid);
                
                const q = query(
                    collection(db, 'reports'), 
                    where('agentUid', '==', agentUid)
                );
                
                const querySnapshot = await getDocs(q);
                
                agentReports = [];
                let pendingCount = 0;
    
                querySnapshot.forEach((doc) => {
                    const report = { 
                        id: doc.id, 
                        ...doc.data(),
                        // Assurer la compatibilité avec les champs de validation
                        isValidated: doc.data().isValidated || false,
                        canEdit: doc.data().canEdit !== undefined ? doc.data().canEdit : true
                    };
                    agentReports.push(report);
                    if (report.status === 'En Cours') {
                        pendingCount++;
                    }
                });
                
                // Trier localement par date de création
                agentReports.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.date || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.date || 0);
                    return dateB - dateA;
                });
                
                displayAgentReports();
                updateAgentStatistics(pendingCount);
                console.log(`${agentReports.length} rapport(s) chargé(s)`);
    
            } catch (error) {
                console.error('Erreur de chargement des rapports:', error);
                
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    showNotification('Index en cours de création, veuillez patienter...', 'warning');
                    setTimeout(() => loadAgentReports(agentUid), 5000);
                } else {
                    showNotification('Erreur lors du chargement des rapports', 'error');
                }
            }
        }
    
        // =================================================================
        // GESTION DE LA DURÉE
        // =================================================================
    
        // Basculer entre les champs de durée
        function toggleDurationFields() {
            const durationUnit = document.getElementById('reportDurationUnit').value;
            const hourFields = document.getElementById('hourDurationFields');
            const dayFields = document.getElementById('dayDurationFields');
            const durationHelp = document.getElementById('durationHelp');
            
            // Masquer tous les champs d'abord
            if (hourFields) hourFields.classList.add('hidden');
            if (dayFields) dayFields.classList.add('hidden');
            if (durationHelp) durationHelp.classList.add('hidden');
            
            // Afficher les champs appropriés
            if (durationUnit === 'Heure' && hourFields) {
                hourFields.classList.remove('hidden');
            } else if (durationUnit === 'Jour' && dayFields) {
                dayFields.classList.remove('hidden');
            } else if (durationHelp) {
                durationHelp.classList.remove('hidden');
            }
        }

        // Initialiser les champs de durée
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                toggleDurationFields();
            }, 100);
        });

        // S'assurer que la fonction est disponible globalement
        window.toggleDurationFields = toggleDurationFields;
    
        // =================================================================
        // GESTION DU MODAL DE RAPPORT
        // =================================================================
    
        // Ouvrir le modal de création de rapport
        window.openReportModal = function() {
            // Réinitialiser le formulaire
            document.getElementById('newReportForm').reset();
            
            // Définir la date actuelle par défaut
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            
            // Définir le statut par défaut à "En Cours"
            document.getElementById('reportStatus').value = 'En Cours';
            
            // Réinitialiser les champs de durée
            toggleDurationFields();
            
            // Réinitialiser les variables globales
            currentEditingReportId = null;
            
            // Changer le titre
            document.getElementById('modalTitle').textContent = 'Créer un Nouveau Rapport d\'Intervention';
            
            // Afficher le modal
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('modalBackdrop').classList.remove('hidden');
            
            // Empêcher le défilement du body
            document.body.style.overflow = 'hidden';
        }
    
        // Fermer le modal de rapport
        window.closeReportModal = function() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('modalBackdrop').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    
        // Soumettre un nouveau rapport
        window.submitReport = async function() {
            try {
                const durationUnit = document.getElementById('reportDurationUnit').value;
                let duration = '';
                
                // Calculer la durée selon l'unité sélectionnée
                if (durationUnit === 'Heure') {
                    const hourCount = document.getElementById('reportHourCount').value;
                    
                    if (!hourCount || hourCount <= 0) {
                        showNotification('Veuillez saisir un nombre d\'heures valide', 'error');
                        return;
                    }
                    
                    duration = `${hourCount} heure(s)`;
                    
                } else if (durationUnit === 'Jour') {
                    const dayCount = document.getElementById('reportDayCount').value;
                    
                    if (!dayCount || dayCount <= 0) {
                        showNotification('Veuillez saisir un nombre de jours valide', 'error');
                        return;
                    }
                    
                    duration = `${dayCount} jour(s)`;
                } else {
                    showNotification('Veuillez sélectionner une unité de durée', 'error');
                    return;
                }
    
                const formData = {
                    clientName: document.getElementById('reportClientSelect').value,
                    interlocutor: document.getElementById('reportInterlocutor').value,
                    contact: document.getElementById('reportContact').value,
                    date: document.getElementById('reportDate').value,
                    site: document.getElementById('reportSite').value,
                    software: document.getElementById('reportSoftwareSelect').value,
                    interventionType: document.getElementById('reportInterventionType').value,
                    contract: document.getElementById('reportContract').value,
                    durationUnit: durationUnit,
                    hourCount: durationUnit === 'Heure' ? document.getElementById('reportHourCount').value : null,
                    dayCount: durationUnit === 'Jour' ? document.getElementById('reportDayCount').value : null,
                    duration: duration,
                    object: document.getElementById('reportObject').value,
                    status: document.getElementById('reportStatus').value,
                    agentUid: currentAgent.uid,
                    agentName: currentAgent.name,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    // Champs pour la validation
                    isValidated: false,
                    canEdit: true
                };
    
                // Validation des champs obligatoires
                if (!formData.clientName || !formData.interlocutor || !formData.contact || 
                    !formData.date || !formData.site || !formData.software || 
                    !formData.interventionType || !formData.contract || !formData.durationUnit ||
                    !formData.object || !formData.status) {
                    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }

                // Validation supplémentaire pour s'assurer que les sélections sont valides
                if (formData.clientName === "" || formData.software === "") {
                    showNotification('Veuillez sélectionner un client et un logiciel valides', 'error');
                    return;
                }
    
                // Si on est en mode édition, mettre à jour le rapport existant
                if (currentEditingReportId) {
                    const reportRef = doc(db, 'reports', currentEditingReportId);
                    await updateDoc(reportRef, formData);
                    showNotification('Rapport modifié avec succès', 'success');
                } else {
                    // Sinon, créer un nouveau rapport
                    await addDoc(collection(db, 'reports'), formData);
                    showNotification('Rapport créé avec succès', 'success');
                }
                
                closeReportModal();
                await loadAgentReports(currentAgent.uid);
                
            } catch (error) {
                console.error('Erreur création/modification rapport:', error);
                if (error.code === 'permission-denied') {
                    showNotification('Permission refusée - Vous ne pouvez pas créer/modifier des rapports', 'error');
                } else {
                    showNotification('Erreur lors de la sauvegarde du rapport', 'error');
                }
            }
        }
    
        // =================================================================
        // AFFICHAGE DES RAPPORTS
        // =================================================================
    
        // Affichage des rapports dans le tableau
        function displayAgentReports() {
            const tableBody = document.getElementById('agentReportsTableBody');
            const noReportsDiv = document.getElementById('noAgentReports');
            tableBody.innerHTML = '';
            
            if (agentReports.length === 0) {
                noReportsDiv.classList.remove('hidden');
                return;
            }
            noReportsDiv.classList.add('hidden');
    
            agentReports.forEach(report => {
                // Déterminer le statut affiché
                let displayStatus = report.status;
                let statusClass = getStatusClass(report.status);
                
                if (report.isValidated) {
                    displayStatus = 'Validé';
                    statusClass = 'bg-green-100 text-green-800 status-validated';
                }
                
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${report.date ? new Date(report.date).toLocaleDateString('fr-FR') : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${report.clientName}</div>
                        <div class="text-sm text-gray-500">${report.site || 'Non spécifié'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                            ${report.interventionType || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${report.duration || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${displayStatus}
                            ${report.isValidated ? '<span class="validation-badge bg-white text-green-800 ml-1"><i class="fas fa-check"></i></span>' : ''}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                        <div class="flex space-x-2 justify-end">
                            <button onclick="viewReportDetails('${report.id}')" class="text-indigo-600 hover:text-indigo-900 transition-colors" title="Voir les détails">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="printReport('${report.id}')" class="text-blue-600 hover:text-blue-900 transition-colors" title="Imprimer">
                                <i class="fas fa-print"></i>
                            </button>
                            <button onclick="sendReportEmail('${report.id}')" class="text-green-600 hover:text-green-900 transition-colors" title="Envoyer par email">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }
    
        // Fonction utilitaire pour obtenir la classe CSS selon le statut
        function getStatusClass(status) {
            switch(status) {
                case 'Terminé':
                    return 'bg-green-100 text-green-800';
                case 'En Cours':
                    return 'bg-blue-100 text-blue-800';
                case 'En Attente':
                    return 'bg-orange-100 text-orange-800';
                case 'Annulé':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
    
        // Mise à jour des statistiques
        function updateAgentStatistics(pendingCount) {
            document.getElementById('agentTotalReports').textContent = agentReports.length;
            
            // Calculer les rapports de la semaine
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekReportsCount = agentReports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate >= oneWeekAgo;
            }).length;
            
            document.getElementById('agentWeekReports').textContent = weekReportsCount;
            document.getElementById('agentPendingReports').textContent = pendingCount;
        }
    
        // =================================================================
        // GESTION DES DÉTAILS DU RAPPORT
        // =================================================================
    
        // Voir les détails d'un rapport
        window.viewReportDetails = function(reportId) {
            const report = agentReports.find(r => r.id === reportId);
            if (!report) return;
    
            currentReportDetails = report;
            const detailsDiv = document.getElementById('reportDetails');
            const editButton = document.getElementById('editReportButton');
            
            // Masquer le bouton modifier si le rapport est validé
            if (report.isValidated) {
                editButton.style.display = 'none';
            } else {
                editButton.style.display = 'block';
            }
            
            detailsDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2 flex items-center">
                                <i class="fas fa-user-tie mr-2"></i>Informations Agent
                            </h4>
                            <p><strong>Nom:</strong> ${report.agentName}</p>
                            <p><strong>Date intervention:</strong> ${report.date}</p>
                            <p><strong>Durée:</strong> ${report.duration}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-800 mb-2 flex items-center">
                                <i class="fas fa-building mr-2"></i>Informations Client
                            </h4>
                            <p><strong>Client:</strong> ${report.clientName}</p>
                            <p><strong>Site:</strong> ${report.site}</p>
                            <p><strong>Interlocuteur:</strong> ${report.interlocutor || 'Non spécifié'}</p>
                            <p><strong>Contact:</strong> ${report.contact || 'Non spécifié'}</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-800 mb-2 flex items-center">
                                <i class="fas fa-tools mr-2"></i>Détails Intervention
                            </h4>
                            <p><strong>Logiciel:</strong> ${report.software}</p>
                            <p><strong>Type:</strong> ${report.interventionType}</p>
                            <p><strong>Sous contrat:</strong> ${report.contract}</p>
                            <p><strong>Statut:</strong> 
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(report.status)}">
                                    ${report.isValidated ? 'Validé' : report.status}
                                    ${report.isValidated ? '<span class="validation-badge bg-white text-green-800 ml-1"><i class="fas fa-check"></i></span>' : ''}
                                </span>
                            </p>
                            ${report.isValidated ? `
                            <p class="text-sm text-green-600 mt-2">
                                <i class="fas fa-lock mr-1"></i>Ce rapport a été validé et ne peut plus être modifié
                            </p>
                            ` : ''}
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-bold text-orange-800 mb-2 flex items-center">
                                <i class="fas fa-clock mr-2"></i>Durée
                            </h4>
                            ${report.durationUnit === 'Heure' ? `
                                <p><strong>Nombre d'heures:</strong> ${report.hourCount}</p>
                            ` : `
                                <p><strong>Nombre de jours:</strong> ${report.dayCount}</p>
                            `}
                            <p><strong>Durée totale:</strong> ${report.duration}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-file-alt mr-2"></i>Objet de la mission
                    </h4>
                    <div class="whitespace-pre-wrap bg-white p-4 rounded border border-gray-200">
                        ${report.object || 'Aucune description fournie'}
                    </div>
                </div>
                ${report.createdAt ? `
                <div class="mt-4 text-sm text-gray-500 text-center">
                    Rapport créé le ${report.createdAt.toDate ? report.createdAt.toDate().toLocaleString('fr-FR') : 'Date inconnue'}
                    ${report.updatedAt && report.updatedAt.toDate ? ` - Modifié le ${report.updatedAt.toDate().toLocaleString('fr-FR')}` : ''}
                    ${report.isValidated && report.validatedAt ? ` - Validé le ${report.validatedAt.toDate().toLocaleString('fr-FR')}` : ''}
                </div>
                ` : ''}
            `;
            
            document.getElementById('detailsModal').classList.remove('hidden');
        }
    
        // Fermer le modal des détails
        window.closeDetailsModal = function() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentReportDetails = null;
        }
    
        // Modifier le rapport actuel
        window.editCurrentReport = function() {
            if (!currentReportDetails) return;
            
            // Vérifier si le rapport peut être modifié
            if (currentReportDetails.isValidated) {
                showNotification('Ce rapport a été validé et ne peut plus être modifié', 'error');
                return;
            }
    
            // Pré-remplir le formulaire avec les données du rapport
            document.getElementById('reportClientSelect').value = currentReportDetails.clientName;
            document.getElementById('reportInterlocutor').value = currentReportDetails.interlocutor;
            document.getElementById('reportContact').value = currentReportDetails.contact;
            document.getElementById('reportDate').value = currentReportDetails.date;
            document.getElementById('reportSite').value = currentReportDetails.site;
            document.getElementById('reportSoftwareSelect').value = currentReportDetails.software;
            document.getElementById('reportInterventionType').value = currentReportDetails.interventionType;
            document.getElementById('reportContract').value = currentReportDetails.contract;
            document.getElementById('reportDurationUnit').value = currentReportDetails.durationUnit;
            document.getElementById('reportStatus').value = currentReportDetails.status;
            document.getElementById('reportObject').value = currentReportDetails.object;
    
            // Pré-remplir les champs de durée selon l'unité
            if (currentReportDetails.durationUnit === 'Heure') {
                document.getElementById('reportHourCount').value = currentReportDetails.hourCount;
            } else if (currentReportDetails.durationUnit === 'Jour') {
                document.getElementById('reportDayCount').value = currentReportDetails.dayCount;
            }
            
            // Afficher les champs de durée appropriés
            toggleDurationFields();
    
            // Mettre à jour l'ID du rapport en cours d'édition
            currentEditingReportId = currentReportDetails.id;
    
            // Changer le titre du modal
            document.getElementById('modalTitle').textContent = 'Modifier le Rapport d\'Intervention';
    
            // Fermer le modal des détails et ouvrir le modal de rapport
            closeDetailsModal();
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('modalBackdrop').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    
        // =================================================================
        // FONCTIONS D'EXPORT ET D'IMPRESSION
        // =================================================================
    
        // Imprimer un rapport spécifique
        window.printReport = function(reportId) {
            const report = agentReports.find(r => r.id === reportId);
            if (!report) return;
    
            currentReportDetails = report;
            preparePrintContent();
            window.print();
        }
    
        // Imprimer le rapport actuellement affiché
        window.printCurrentReport = function() {
            if (!currentReportDetails) return;
            preparePrintContent();
            window.print();
        }
    
        // Préparer le contenu pour l'impression
        function preparePrintContent() {
            if (!currentReportDetails) return;
    
            const report = currentReportDetails;
            const printContent = document.getElementById('printContent');
            const printDate = document.getElementById('printDate');
            
            printDate.textContent = new Date().toLocaleDateString('fr-FR');
            
            printContent.innerHTML = `
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Rapport d'Intervention</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="border-b pb-2">
                            <strong>Agent:</strong> ${report.agentName}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Date:</strong> ${report.date}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Client:</strong> ${report.clientName}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Site:</strong> ${report.site}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Interlocuteur:</strong> ${report.interlocutor || 'Non spécifié'}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Contact:</strong> ${report.contact || 'Non spécifié'}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Logiciel:</strong> ${report.software}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Type:</strong> ${report.interventionType}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Durée:</strong> ${report.duration}
                        </div>
                        <div class="border-b pb-2">
                            <strong>Statut:</strong> ${report.isValidated ? 'Validé' : report.status}
                        </div>
                    </div>
                    
                    ${report.durationUnit === 'Heure' ? `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Détails de la durée</h4>
                        <p><strong>Nombre d'heures:</strong> ${report.hourCount}</p>
                    </div>
                    ` : `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Détails de la durée</h4>
                        <p><strong>Nombre de jours:</strong> ${report.dayCount}</p>
                    </div>
                    `}
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Objet de la mission</h4>
                        <div class="whitespace-pre-wrap border border-gray-300 p-4 rounded bg-gray-50">
                            ${report.object || 'Aucune description fournie'}
                        </div>
                    </div>
                    
                    ${report.isValidated ? `
                    <div class="bg-green-50 p-4 rounded border border-green-200 mb-6">
                        <p class="text-green-800 font-semibold">
                            <i class="fas fa-check-circle mr-2"></i>Rapport validé
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="text-sm text-gray-500 mt-8">
                        Document généré automatiquement par InovaReport
                    </div>
                </div>
            `;
            
            document.getElementById('printSection').classList.remove('hidden');
        }
    
        // Envoyer un rapport par email
        window.sendReportEmail = function(reportId) {
            const report = agentReports.find(r => r.id === reportId);
            if (!report) return;
    
            const subject = `Rapport d'intervention - ${report.clientName} - ${report.date}`;
            const body = `
    Bonjour,
    
    Veuillez trouver ci-joint le rapport d'intervention technique.
    
    Client: ${report.clientName}
    Date: ${report.date}
    Agent: ${report.agentName}
    Type: ${report.interventionType}
    Durée: ${report.duration}
    Statut: ${report.isValidated ? 'Validé' : report.status}
    
    Objet de la mission:
    ${report.object || 'Aucune description fournie'}
    
    Cordialement,
    ${report.agentName}
            `.trim();
    
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        }
    
        // Envoyer le rapport actuel par email
        window.sendReportByEmail = function() {
            if (!currentReportDetails) return;
            window.sendReportEmail(currentReportDetails.id);
        }
    
        // =================================================================
        // FONCTIONS UTILITAIRES
        // =================================================================
    
        // Fonction de déconnexion
        window.logout = async function() {
            try {
                await authService.logout();
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
            }
        };
    
        // Fonction utilitaire pour les notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-orange-500' : 'bg-blue-500'
            } text-white`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas ${icon}"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('opacity-100');
            }, 10);
            
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    
        // =================================================================
        // GESTION DES ÉVÉNEMENTS
        // =================================================================
    
        // Cacher la section d'impression après l'impression
        window.addEventListener('afterprint', function() {
            document.getElementById('printSection').classList.add('hidden');
        });
    
        // Gestionnaire d'événement pour la touche Échap
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeReportModal();
                closeDetailsModal();
            }
        });
    </script>
</body>
</html>